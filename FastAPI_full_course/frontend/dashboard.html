<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π –∫–∞–±–∏–Ω–µ—Ç - Marketplace</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <nav class="navbar">
                <div class="nav-brand">
                    <a href="index.html" class="nav-link">üõçÔ∏è Marketplace</a>
                </div>
                <div class="nav-links">
                    <a href="index.html" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a>
                    <a href="products.html" class="nav-link">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</a>
                    <a href="dashboard.html" class="nav-link active">–ú–æ–π –∫–∞–±–∏–Ω–µ—Ç</a>
                    <div id="admin-links" style="display: none;">
                        <a href="admin.html" class="nav-link">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</a>
                    </div>
                    <button onclick="logout()" class="btn btn-outline">–í—ã–π—Ç–∏</button>
                </div>
            </nav>
        </header>

        <main>
            <div class="dashboard-header">
                <h1>–ú–æ–π –∫–∞–±–∏–Ω–µ—Ç</h1>
                <p id="user-welcome">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>

            <div class="dashboard-actions">
                <button onclick="showCreateProductModal()" class="btn btn-primary">
                    üì¶ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
                </button>
                <div id="admin-button-container" style="display: none; margin-left: 10px;">
                    <a href="admin.html" class="btn btn-warning">üëë –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</a>
                </div>
            </div>

            <div class="dashboard-section">
                <h2>–ú–æ–∏ —Ç–æ–≤–∞—Ä—ã</h2>
                <div id="dashboard-content">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞—à–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
    <div id="create-product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
                <button onclick="hideModal('create-product-modal')" class="btn-close">√ó</button>
            </div>
            <form id="create-product-form" class="modal-form">
                <div class="form-group">
                    <label for="product-name">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
                    <input type="text" id="product-name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="product-description">–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
                    <textarea id="product-description" name="description" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 5 —à—Ç—É–∫)</label>
                    <input type="file" id="product-images" multiple accept="image/*">
                </div>
                <div class="form-group">
                    <label>–í–∏–¥–µ–æ (–¥–æ 2 —à—Ç—É–∫)</label>
                    <input type="file" id="product-videos" multiple accept="video/*">
                </div>
                <div class="form-actions">
                    <button type="button" onclick="hideModal('create-product-modal')" class="btn btn-outline">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="btn btn-primary">
                        –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è dashboard
        function showCreateProductModal() {
            document.getElementById('create-product-modal').style.display = 'flex';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function loadDashboardContent() {
            console.log("üéØ Loading dashboard content...");

            if (!currentUser) {
                console.log("‚ùå No user for dashboard content");
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω–∫–∏ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω
            if (currentUser.role === 'admin') {
                document.getElementById('admin-button-container').style.display = 'inline-block';
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
            try {
                const response = await fetch('http://localhost:8000/api/products/');
                const products = await response.json();
                const myProducts = products.filter(p => p.owner_id === currentUser.id);

                const contentEl = document.getElementById('dashboard-content');

                if (myProducts.length === 0) {
                    contentEl.innerHTML = `
                        <div class="empty-state">
                            <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</h3>
                            <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø—Ä–æ–¥–∞–≤–∞—Ç—å!</p>
                            <button onclick="showCreateProductModal()" class="btn btn-primary">
                                –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
                            </button>
                        </div>
                    `;
                } else {
                    contentEl.innerHTML = `
                        <div class="products-grid">
                            ${myProducts.map(product => `
                                <div class="product-card">
                                    <img src="http://localhost:8000${product.image_paths?.[0] || '/static/uploads/default-product.jpg'}"
                                         alt="${product.name}" class="product-image">
                                    <div class="product-info">
                                        <h3 class="product-name">${product.name}</h3>
                                        <p class="product-description">${product.description}</p>
                                        <button onclick="deleteProduct(${product.id})" class="btn btn-outline btn-small">
                                            –£–¥–∞–ª–∏—Ç—å
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('dashboard-content').innerHTML = `
                    <div class="empty-state">
                        <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</h3>
                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
                    </div>
                `;
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
        async function deleteProduct(productId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?')) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`http://localhost:8000/api/products/${productId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });

                if (response.ok) {
                    showMessage('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω', 'success');
                    loadDashboardContent();
                } else {
                    showMessage('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞', 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
        document.getElementById('create-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('name', document.getElementById('product-name').value);
            formData.append('description', document.getElementById('product-description').value);

            const imagesInput = document.getElementById('product-images');
            const videosInput = document.getElementById('product-videos');

            for (let file of imagesInput.files) {
                formData.append('images', file);
            }

            for (let file of videosInput.files) {
                formData.append('videos', file);
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:8000/api/products/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                    body: formData,
                });

                if (response.ok) {
                    showMessage('–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', 'success');
                    hideModal('create-product-modal');
                    document.getElementById('create-product-form').reset();
                    loadDashboardContent();
                } else {
                    showMessage('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞', 'error');
                }
            } catch (error) {
                console.error('Create product error:', error);
                showMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
        setTimeout(() => {
            if (currentUser) {
                loadDashboardContent();
            }
        }, 500);
    </script>
</body>
</html>